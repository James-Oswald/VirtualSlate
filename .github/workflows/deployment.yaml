name: Build VirtualSlate
on:
  push: {}
  pull_request: {}
# This job works perfectly, you are able to manually download artifact and export game(second step)
jobs:
  Build-Extension:
    runs-on: ubuntu-latest
    steps:
     - name: Updates Packages
       run: sudo apt-get update
     - name: Install Scons
       run: sudo apt-get -y install scons gcc-mingw-w64
     - name: Install Compiler
       run: yes | sudo apt-get install g++-mingw-w64-x86-64
     - name: Get Repo
       uses: actions/checkout@v4
       with:
         submodules: recursive
     - name: Build Extension
       run: scons platform=windows
     - name: Upload Artifact
       uses: actions/upload-artifact@v3
       with:
          name: VirtualSlateBuildFiles
          path: ./

  Build-Game:
    runs-on: windows-latest
    needs: Build-Extension
    steps:
      - name: Retrieve Build
        uses: actions/download-artifact@v3
        with:
          name: VirtualSlateBuildFiles
      - name: Download Engine
        run: Invoke-WebRequest https://downloads.tuxfamily.org/godotengine/4.1.2/Godot_v4.1.2-stable_win64.exe.zip -OutFile godotbuilder.zip
      - name: Unzip Engine
        run: Expand-Archive godotbuilder.zip -DestinationPath ./
      - name: Download Export Templates
        run: Invoke-WebRequest https://downloads.tuxfamily.org/godotengine/4.1.2/godot-lib.4.1.2.stable.template_release.aar -OutFile export_templates.zip
      - name: Unzip Export Templates
        run: Expand-Archive export_templates.zip -DestinationPath ./
      - name: Make Game
        run: ls; ./Godot_v4.1.2-stable_win64_console.exe --headless --path project --export-debug "Windows Desktop"
      - name: DEBUG Looking for game
        run: cd project; ls
      - name: Upload exe
        uses: actions/upload-artifact@v3
        with:
          name: VirtualSlate-x64
          path: project/
